<?php
// Google Drive API থেকে ভিডিও ডেটা নেওয়ার ফাংশন
function getDriveVideoData($driveId, $apiKey) {
    // ফাইল মেটাডেটা পাওয়ার জন্য API কল
    $metadataUrl = "https://www.googleapis.com/drive/v3/files/{$driveId}?key={$apiKey}&fields=name,mimeType,size";
    $metadata = json_decode(file_get_contents($metadataUrl), true);
    
    // ভিডিও সোর্স URL
    $videoUrl = "https://www.googleapis.com/drive/v3/files/{$driveId}?alt=media&key={$apiKey}";
    
    return [
        'title' => $metadata['name'] ?? 'Google Drive Video',
        'sources' => [
            ['file' => $videoUrl, 'type' => 'mp4', 'label' => 'Auto']
        ],
        'image' => "https://lh3.googleusercontent.com/d/{$driveId}"
    ];
}

// URL থেকে ID প্যারামিটার পড়া
$idParam = $_GET['id'] ?? '';
$videoData = null;

if ($idParam) {
    try {
        $json = json_decode(base64_decode($idParam), true);
        $driveId = $json['id'] ?? '';
        
        if ($driveId) {
            $apiKeys = [
                'AIzaSyCt3DULzE2trDJhfFUosWZT-3GEObbMqVU',
                'AIzaSyCsbx8BSyLwkw6XX6Lg5OF1U0HNtI9VmCY',
                'AIzaSyBLMJAT6oqTZxAMsCsMjXzoo4lkJL4MmfM',
                'AIzaSyCIY6fomcJxOt0XQ_naa1rzfd5wlOMGKDY'
            ];
            $apiKey = $apiKeys[array_rand($apiKeys)];
            $videoData = getDriveVideoData($driveId, $apiKey);
        }
    } catch (Exception $e) {
        error_log('Error parsing video ID: ' . $e->getMessage());
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JW Player - Google Drive Video</title>
    
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; }
        #player-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* লোডিং ইন্ডিকেটর */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 15px 30px;
            border-radius: 50px;
            font-family: Arial, sans-serif;
            z-index: 1000;
            display: <?php echo $videoData ? 'none' : 'flex'; ?>;
        }
    </style>
    
    <!-- JW Player Script -->
    <script src="https://ssl.p.jwpcdn.com/player/v/8.26.9/jwplayer.js"></script>
    <script>jwplayer.key = "ITWMv7t88JGzI0xPwW8I0+LveiXX9SWbfdmt0ArUSyc=";</script>
</head>
<body>
    <div class="loading" id="loading">
        <?php echo $videoData ? 'ভিডিও লোড হচ্ছে...' : 'ভিডিও আইডি পাওয়া যায়নি'; ?>
    </div>
    
    <div id="player-container"></div>

    <?php if ($videoData): ?>
    <script>
        window.onload = function() {
            const loading = document.getElementById('loading');
            
            var player = jwplayer("player-container").setup({
                "playlist": [{
                    "title": "<?php echo addslashes($videoData['title']); ?>",
                    "image": "<?php echo $videoData['image']; ?>",
                    "sources": [
                        <?php foreach ($videoData['sources'] as $source): ?>
                        {
                            "file": "<?php echo $source['file']; ?>",
                            "type": "<?php echo $source['type']; ?>",
                            "label": "<?php echo $source['label']; ?>",
                            "default": <?php echo isset($source['default']) ? 'true' : 'false'; ?>
                        },
                        <?php endforeach; ?>
                    ]
                }],
                "autostart": true,
                "controls": true,
                "displaytitle": true,
                "width": "100%",
                "height": "100%",
                "stretching": "uniform",
                "playbackRateControls": true,
                "playbackRates": [0.5, 1, 1.25, 1.5, 2],
                "skin": {
                    "controlbar": { "iconsActive": "#23ade5" },
                    "timeslider": { "progress": "#23ade5" }
                }
            });

            player.on('ready', function() {
                loading.style.display = 'none';
                console.log('JW Player ready with Google Drive video');
            });

            player.on('error', function(e) {
                console.error('Player error:', e);
                loading.innerHTML = 'ভিডিও লোড করতে সমস্যা হয়েছে';
                loading.style.display = 'flex';
            });

            // কী-বোর্ড শর্টকাট
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space') {
                    e.preventDefault();
                    player.pause(!player.getState());
                }
                if (e.code === 'ArrowLeft') {
                    player.seek(player.getPosition() - 10);
                }
                if (e.code === 'ArrowRight') {
                    player.seek(player.getPosition() + 10);
                }
                if (e.code === 'KeyM') {
                    player.setMute(!player.getMute());
                }
                if (e.code === 'KeyF') {
                    player.setFullscreen(!player.getFullscreen());
                }
            });
        };
    </script>
    <?php else: ?>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                window.location.href = '/';
            }, 3000);
        });
    </script>
    <?php endif; ?>
</body>
</html>
